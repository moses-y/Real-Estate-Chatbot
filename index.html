<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kwetu Homes AI Assistant - Real Estate Chatbot</title>
    <meta name="description" content="Kwetu Homes AI Assistant helps you find your dream property with instant answers about real estate options, buying process, and property information.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Modern color scheme and design variables */
        :root {
            /* Higher contrast colors */
            --primary-color: #1a365d;  /* Darker blue for better contrast */
            --secondary-color: #4299e1;
            --accent-color: #dd6b20;   /* Darker orange for better contrast */
            --light-bg: #b7b9bb;
            --dark-text: #1a202c;      /* Nearly black text */
            --light-text: #d7c6c6;     /* Pure white for maximum contrast on dark backgrounds */
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
            --border-radius: 10px;
            --border-radius-sm: 5px;
            --border-radius-lg: 20px;

            /* Glass-like variables */
            --glass-bg: rgba(95, 67, 67, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --glass-blur: blur(4px);
        }

        /* Improve focus states for keyboard navigation */
        a:focus, button:focus, input:focus, select:focus {
            outline: 3px solid #4299e1;
            outline-offset: 2px;
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background-color: #f5f7fa;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234299e1' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
        }

        /* Enhanced Header styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            margin-bottom: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            height: 60px;
            transition: var(--transition);
        }

        .logo img:hover {
            transform: scale(1.05);
        }

        .logo h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 700;
        }

        /* Improved Navigation styles */
        .nav-links {
            display: flex;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        .nav-link {
            padding: 12px 20px;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-link:hover {
            background-color: rgba(66, 153, 225, 0.1);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: white;
            border-radius: 50%;
        }

        /* Main content styles */
        main {
            display: flex;
            flex-direction: column; /* Stack chat area and other sections */
            flex: 2; /* Take up more space */
            min-width: 0;
        }

        /* Enhanced chat container styles */
        .chat-area {
            display: flex;
            flex-direction: column; /* Stack chat container and suggestions */
            margin-bottom: 10px; /* Add spacing below chat area */
        }

        .chat-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            display: flex;
            flex-direction: column;
            height: 700px;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 10px;
            background-color: var(--primary-color);
            color: white;
        }

        .chat-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.8;
            transition: var(--transition);
        }

        .action-btn:hover {
            opacity: 1;
        }

        .chat-box {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: transparent; /* Make background transparent */
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        /* Improved chat bubbles */
        .message {
            position: relative;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.3;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }

        .bot {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--dark-text);
            border-radius: 20px;
            align-self: flex-start;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        .user {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--dark-text);
            border-radius: 20px;
            align-self: flex-end;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        .message-content {
            word-wrap: break-word;
        }

        .message-timestamp {
            position: absolute;
            bottom: -18px;
            font-size: 0.7em;
            color: #718096;
            opacity: 0.7;
        }

        .bot .message-timestamp {
            left: 5px;
        }

        .user .message-timestamp {
            right: 5px;
        }

        /* Typing indicator animation */
        .typing-indicator-container {
            padding: 15px;
            width: auto;
            max-width: 150px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .typing-indicator span {
            height: 10px;
            width: 10px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: inline-block;
            opacity: 0.7;
        }

        .typing-indicator span:nth-child(1) {
            animation: bounce 1.2s infinite 0.1s;
        }
        .typing-indicator span:nth-child(2) {
            animation: bounce 1.2s infinite 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation: bounce 1.2s infinite 0.3s;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }

        /* Chat controls */
        .chat-controls {
            display: flex;
            justify-content: flex-end;
            padding: 10px 15px;
            border-top: 1px solid #eee;
            background: var(--glass-bg);
            border-top: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        .control-btn {
            padding: 8px 12px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background-color: #e0e0e0;
        }

        /* Enhanced input area */
        .input-area {
            display: flex;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #eee;
            background: var(--glass-bg);
            border-top: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
        }

        .input-area input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e1e1e1;
            border-radius: 24px;
            font-size: 16px;
            transition: var(--transition);
        }

        .input-area input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
            outline: none;
        }

        .input-area button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 24px;
            width: 46px;
            height: 46px;
            margin-left: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-area button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Enhanced suggestion chips */
        .suggestions {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            padding: 20px;
        }

        .suggestions h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .suggestion-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--primary-color);
            border-radius: 18px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            backdrop-filter: var(--glass-blur);
        }

        .suggestion-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Enhanced feedback buttons */
        .feedback-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .feedback-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            opacity: 0.7;
        }

        .feedback-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .feedback-btn.helpful {
            color: #38A169;
        }

        .feedback-btn.not-helpful {
            color: #E53E3E;
        }

        .feedback-text {
            font-size: 12px;
            color: #718096;
        }

        /* Quick actions section */
        .quick-actions {
            margin-top: 25px;
            border-top: 1px solid #edf2f7;
            padding-top: 20px;
        }

        .quick-actions h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-btn {
            padding: 10px 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--primary-color);
            border-radius: var(--border-radius-sm);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-size: 14px;
            backdrop-filter: var(--glass-blur);
        }

        .action-btn:hover {
            background-color: #edf2f7;
            transform: translateY(-2px);
        }

        /* Featured property card */
        .property-highlight {
            margin-top: 25px;
            border-top: 1px solid #edf2f7;
            padding-top: 20px;
        }

        .property-highlight h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .mini-property-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            transition: var(--transition);
            backdrop-filter: var(--glass-blur);
        }

        .mini-property-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .mini-property-image {
            height: 150px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .property-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .mini-property-info {
            padding: 12px;
        }

        .mini-property-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .mini-property-location {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }

        .mini-property-price {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .mini-view-details {
            display: flex;
            width: 100%;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: bold;
        }

        .mini-view-details:hover {
            background-color: var(--secondary-color);
        }

        /* Enhanced property cards */
        .property-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 25px;
            backdrop-filter: var(--glass-blur);
        }

        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .property-image {
            height: 220px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .property-info {
            padding: 20px;
        }

        .property-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .property-location {
            display: flex;
            align-items: center;
            color: #718096;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .property-location::before {
            content: "üìç";
            margin-right: 5px;
        }

        .property-price {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .property-features {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #edf2f7;
        }

        .feature {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #4a5568;
            gap: 5px;
        }

        .view-btn {
            width: 100%;
            padding: 10px 0;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .view-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Property search styles */
        .search-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-filters {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            padding: 20px;
        }

        /* GitHub link */
        .github-link {
            margin-top: 20px;
            text-align: center;
        }

        .github-link a {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            background-color: #24292e;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .github-link a:hover {
            background-color: #3a3a3a;
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        /* Shortcuts info */
        .shortcuts-info {
            margin: 15px 0;
            text-align: center;
            color: #718096;
            font-size: 13px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            backdrop-filter: var(--glass-blur);
            padding: 10px;
        }

        /* Enhanced footer */
        footer {
            margin-top: 40px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            padding: 20px;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .footer-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #4a5568;
            text-decoration: none;
            transition: var(--transition);
            font-size: 14px;
        }

        .footer-links a:hover {
            color: var(--primary-color);
        }

        .footer-social {
            display: flex;
            gap: 15px;
        }

        .footer-social a {
            color: #4a5568;
            font-size: 18px;
            transition: var(--transition);
        }

        .footer-social a:hover {
            color: var(--primary-color);
            transform: translateY(-3px);
        }

        .copyright {
            text-align: center;
            color: #718096;
            font-size: 14px;
            padding-top: 15px;
            border-top: 1px solid #edf2f7;
        }

        /* In-chat property results */
        .chat-property-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-property-card {
            display: flex;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            transition: var(--transition);
            backdrop-filter: var(--glass-blur);
        }

        .chat-property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chat-property-image {
            width: 80px;
            height: 80px;
            background-size: cover;
            background-position: center;
        }

        .chat-property-info {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        .chat-property-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .chat-property-location {
            color: #718096;
            margin-bottom: 3px;
        }

        .chat-property-price {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 3px;
        }

        .chat-property-specs {
            color: #718096;
            margin-bottom: 5px;
        }

        .chat-property-link {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 11px;
        }

        .view-all-link {
            text-align: center;
            display: flex;
            margin-top: 5px;
            color: var(--secondary-color);
            text-decoration: none;
        }

        /* Demo notice */
        .demo-notice {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(66, 153, 225, 0); }
            100% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column; /* Stack items vertically */
                align-items: stretch; /* Stretch items to fill width */
            }

            header {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
            }

            .logo {
                margin-bottom: 10px;
            }

            .nav-links {
                width: 100%;
                justify-content: space-between;
            }

            .nav-link {
                padding: 10px;
                font-size: 14px;
                justify-content: center;
                flex: 1;
            }

            main {
                width: 100%; /* Take full width */
                order: 1; /* Moves chat to the top */
                flex-direction: column; /* Stack chat and suggestions */
            }

            .chat-container {
                height: 450px;
                margin-bottom: 20px;
                margin-right: 0; /* Remove right margin on mobile */
            }

            .message {
                max-width: 90%;
            }

            .input-area {
                padding: 10px;
            }

            .input-area input {
                padding: 10px 15px;
            }

            .suggestions {
                order: -1;
                margin-bottom: 20px;
            }

            .suggestion-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .footer-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 15px;
            }

            .search-filters > div {
                grid-template-columns: 1fr !important;
            }

            .side-nav {
                width: 100%; /* Take full width on mobile */
                margin-left: 0; /* Remove left margin on mobile */
                margin-top: 20px; /* Add some space above side-nav when stacked below main */
                order: 2; /* Moves side nav below chat */
            }

            .input-area button {
                width: 56px; /* Larger touch target */
                height: 56px; /* Larger touch target */
            }

            /* Improve spacing for property cards */
            .property-card {
                margin-bottom: 30px;
            }
        }

        .show-suggestions {
            display: flex !important;
        }
        .suggestions h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .suggestion-btn {
            background-color: var(--light-bg);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .suggestion-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        .side-nav {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            flex: 1; /* Take up remaining space */
            padding: 10px;
            min-width: 200px; /* Ensure side-nav doesn't collapse too much */
            max-width: 300px; /* Limit side-nav width */
        }

        .side-nav h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .side-nav-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--primary-color);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            margin-bottom: 10px;
            backdrop-filter: var(--glass-blur);
        }

        .side-nav-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="images/logo.png" alt="Kwetu Homes Logo" onerror="this.src='https://via.placeholder.com/60x60?text=KH';this.onerror='';">
            <h1>Kwetu Homes AI Assistant</h1>
        </div>
        <div class="nav-links">
            <a href="#" class="nav-link active" id="chat-link">
                <i class="fas fa-comment-dots"></i> Chatbot
            </a>
            <a href="#" class="nav-link" id="search-link">
                <i class="fas fa-search"></i> Property Search
            </a>
        </div>
    </header>

    <div class="container">
        <main id="chat-view">
            <div class="chat-container">
                <div class="chat-header">
                    <h2><i class="fas fa-robot"></i> Kwetu Homes AI Assistant</h2>
                    <div class="chat-header-actions">
                        <button id="toggle-suggestions" title="Toggle suggestions panel" class="action-btn">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-box" id="chat-box">
                    <div class="message bot" id="msg-welcome">
                        <div class="message-content">
                            <img src="images/bot.png" class="avatar" alt="Bot Avatar" onerror="this.src='https://via.placeholder.com/30x30?text=Bot';this.onerror='';">
                            Hello! I'm the Kwetu Homes AI Assistant. How can I help you today? I can provide information about properties, buying process, mortgages, and more.
                        </div>
                        <div class="feedback-buttons">
                            <button class="feedback-btn helpful" onclick="provideFeedback(this, true)" title="This was helpful">üëç</button>
                            <button class="feedback-btn not-helpful" onclick="provideFeedback(this, false)" title="This needs improvement">üëé</button>
                        </div>
                        <div class="message-timestamp">Now</div>
                    </div>
                </div>
                
                <div class="chat-controls">
                    <button id="reset-chat" class="control-btn">
                        <i class="fas fa-trash-alt"></i> Clear Conversation
                    </button>
                </div>
                
                <div class="input-area">
                    <label for="user-input" class="sr-only">Type your message</label>
                    <input type="text" id="user-input" 
                           aria-label="Type your message" 
                           placeholder="Ask me anything about real estate..."
                           autocomplete="off">
                    <button id="send-btn" aria-label="Send message">
                        <i class="fas fa-paper-plane" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </main>
        
        <aside class="side-nav">
            <!-- Suggestions Section (Moved from main) -->
            <section class="side-nav-section">
                <h3><i class="fas fa-lightbulb"></i> Suggestions</h3>
                <div class="suggestion-buttons">
                    <button class="suggestion-btn" onclick="sendMessage(this.textContent)">Property viewing process</button>
                    <button class="suggestion-btn" onclick="sendMessage(this.textContent)">Document requirements</button>
                    <button class="suggestion-btn" onclick="sendMessage(this.textContent)">Property prices in Nairobi</button>
                    <button class="suggestion-btn" onclick="sendMessage(this.textContent)">Mortgage options</button>
                </div>
            </section>
            
            <!-- Quick Actions Section (Moved from main) -->
            <section class="side-nav-section">
                <h3><i class="fas fa-tools"></i> Quick Actions</h3>
                <button class="side-nav-btn" id="search-properties-btn">
                    <i class="fas fa-search"></i> Search Properties
                </button>
                <button class="side-nav-btn" id="schedule-viewing-btn" onclick="sendMessage('I would like to schedule a property viewing')">
                    <i class="fas fa-calendar-alt"></i> Schedule Viewing
                </button>
            </section>
            
            <!-- Featured Property Section (Already in side-nav) -->
            <section class="side-nav-section">
                <h3><i class="fas fa-home"></i> Featured Property</h3>
                <div class="mini-property-card">
                    <div class="mini-property-image" style="background-image: url('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTd8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60')">
                        <div class="property-badge">Featured</div>
                    </div>
                    <div class="mini-property-info">
                        <div class="mini-property-title">Modern 2 Bedroom Apartment</div>
                        <div class="mini-property-location">Westlands, Nairobi</div>
                        <div class="mini-property-price">KES 9,500,000</div>
                        <button class="mini-view-details" onclick="sendMessage('Tell me about the Westlands apartment')">View Details</button>
                    </div>
                </div>
            </section>

            <div class="github-link">
                <a href="https://github.com/moses-y/Real-Estate-Chatbot" target="_blank">
                    <i class="fab fa-github"></i> View on GitHub
                </a>
            </div>
        </aside>
    </div>

    <div id="search-view" style="display: none;">
        <div class="search-container">
            <h2><i class="fas fa-search"></i> Find Your Dream Property</h2>
            <div class="search-filters">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="Enter location..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius-sm);">
                    </div>
                    <div>
                        <label for="min_price">Min Price</label>
                        <input type="number" id="min_price" placeholder="KES" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius-sm);">
                    </div>
                    <div>
                        <label for="max_price">Max Price</label>
                        <input type="number" id="max_price" placeholder="KES" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius-sm);">
                    </div>
                    <div>
                        <label for="type">Property Type</label>
                        <select id="type" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius-sm);">
                            <option value="">Any</option>
                            <option value="apartment">Apartment</option>
                            <option value="villa">Villa</option>
                            <option value="house">House</option>
                            <option value="commercial">Commercial</option>
                            <option value="land">Land</option>
                        </select>
                    </div>
                    <div>
                        <label for="bedrooms">Bedrooms</label>
                        <input type="number" id="bedrooms" placeholder="Number of bedrooms" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius-sm);">
                    </div>
                </div>
                <button id="search-btn" style="padding: 12px 25px; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-search"></i> Search Properties
                </button>
            </div>
            <div id="property-results" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                <!-- Property cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <div class="shortcuts-info">
        <p><strong>Keyboard shortcuts:</strong> Alt+R to reset chat ‚Ä¢ Alt+S to focus search input</p>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="images/logo.png" alt="Kwetu Homes Logo" width="40" onerror="this.src='https://via.placeholder.com/40x40?text=KH';this.onerror='';">
                <span>Kwetu Homes AI Assistant</span>
            </div>
            <div class="footer-links">
                <a href="#">About Us</a>
                <a href="#">Contact</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="footer-social">
                <a href="#" title="Facebook"><i class="fab fa-facebook"></i></a>
                <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
            </div>
        </div>
        <div class="copyright">
            <p>&copy; 2025 Kwetu Homes Real Estate. All rights reserved.</p>
        </div>
    </footer>
</div>
<div class="sr-only" aria-live="polite" id="chat-status"></div>

<script>
    function updateScreenReaderStatus(message) {
        document.getElementById('chat-status').textContent = message;
    }
    
    // Add keyboard support for chat suggestions
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    sendMessage(this.textContent);
                }
            });
        });
    });

    // Focus trap for modal dialogs
    function setupFocusTrap(modalElement) {
        const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        modalElement.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                if (e.shiftKey && document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        });
    }
    
    // Add clear loading states
    function showLoadingState(isLoading) {
        const inputArea = document.querySelector('.input-area');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        if (isLoading) {
            inputArea.classList.add('loading');
            userInput.disabled = true;
            sendBtn.disabled = true;
            updateScreenReaderStatus("Processing your request...");
        } else {
            inputArea.classList.remove('loading');
            userInput.disabled = false;
            sendBtn.disabled = false;
            updateScreenReaderStatus("Response received");
        }
    }

    // Better error handling
    function handleError(message) {
        addMessage("I'm sorry, I encountered an error. Please try again or refresh the page.", false);
        console.error(message);
        updateScreenReaderStatus("An error occurred");
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Chatbot dataset (version of your qa_data.py)
        const qaData = {
            "questions": [
                "How can I schedule a property viewing?",
                "What documents do I need to buy a house?",
                "What is the price range for houses in Nyeri?",
                "How do I check if a property has a valid title deed?",
                "What are the steps to buying land in Nairobi?",
                "Do you have rental apartments in Eldoret?",
                "What should I consider when choosing a real estate agent?",
                "What are the legal requirements for buying a house in Kitengela?",
                "Do you offer virtual property tours?",
                "What factors affect property value appreciation?",
                "Can I negotiate the price of a house?",
                "What is the best location to invest in real estate currently?",
                "What financing options do you offer for home purchases?",
                "How do I calculate my monthly mortgage payments?",
                "What are the common home loan interest rates?",
                "I would like to buy property",
                "I want to buy a house",
                "How do I buy property?",
                "What do I need to buy a house?",
                "What documents are needed to buy property?",
                "What is the process of buying a house?",
                "I have money and want to buy property",
                "I have 1 million, what property can I buy?",
                "If I have 1 million as deposit, what can I get?",
                "What can I buy with 1 million shillings?",
                "What locations do you have properties in?",
                "Where are your properties located?",
                "Which areas do you have houses in?",
                "Property locations for 10 million",
                "What locations can I buy with 10 million?",
                "Any other locations for 10 million?",
                "Share locations that I can buy with 10 million",
                "Where can I buy property with 10 million?",
                "What areas have properties within 10 million?",
                "Show me locations with properties around 10 million",
                "What are the available properties for sale in Kitengela?",
                "Do you offer short-term rental properties?",
                "What is the return on investment (ROI) for rental properties?",
                "How can I determine the market value of my property?",
                "What are the legal requirements for buying a house in Nairobi?",
                "How do I list my property for sale with Kwetu Homes?",
                "What amenities are available in Kwetu Homes properties?",
                "Are there any additional costs when purchasing a home?",
                "Do you provide property management services?",
                "How long does the home buying process take?",
                "What are the different property types available at Kwetu Homes?",
                "Can I purchase a home with a payment plan?",
                "What is the process of renting a home with Kwetu Homes?",
                "Do you assist with mortgage financing?",
                "What are the legal steps involved in buying a property?",
                "Can I buy land from Kwetu Homes?",
                "What are the benefits of investing in real estate?",
                "How can I check the ownership history of a property?",
                "What should I consider before buying an apartment?",
                "What is the average rental yield for properties in Nairobi?",
                "What happens if I default on my mortgage payments?",
                "Does Kwetu Homes offer furnished apartments?",
                "Are there discounts for first-time homebuyers?",
                "How do I transfer property ownership?",
                "What security features are available in Kwetu Homes estates?",
                "Are there any upcoming property developments by Kwetu Homes?",
                "Can I get assistance in reselling my property?",
                "What is the minimum deposit required to buy a property?",
                "Do you provide rental management services?",
                "What documents do I need to apply for a home loan?",
                "How can I increase the value of my property before selling?",
                "Can foreigners buy property in Kenya?",
                "What factors determine property price changes?",
                "How do I confirm that a property is legally registered?",
                "What is the land tenure system in Kenya?",
                "What are the tax implications of buying property?",
                "How do I calculate the return on investment for a rental property?",
                "What areas in Kenya have the highest property appreciation rates?",
                "What are the risks of real estate investment?",
                "How do I identify a good property investment opportunity?",
                "What is the difference between leasehold and freehold property?",
                "How do I conduct due diligence before buying property?",
                "What are the current mortgage interest rates?",
                "How do I qualify for a mortgage loan?",
                "What are the benefits of working with a real estate agent?",
                "How do I know if a property is priced fairly?",
                "What are the hidden costs of buying property?",
                "How long should I expect to wait before selling a property for profit?",
                "What renovations add the most value to a property?",
                "How do I handle property disputes with neighbors?",
                "Yes, show me specific options",
                "Yes please share options",
                "Show me available properties",
                "Tell me more about the properties",
                "What specific options do you have?",
                "Yes, I'd like to see listings",
                "Share more details please",
                "Can you show me what's available?",
                "Yes, tell me about specific properties",
                "I want to see the available options",
                "What types of properties do you have in Westlands?",
                "Tell me about the Westlands apartment",
                "What amenities are included in the Westlands apartment?",
                "Are there any properties with swimming pools?",
                "Do your properties have backup generators?",
                "Are there any pet-friendly properties?",
                "Do you have properties with garden space?",
                "Are there any properties with a gym?",
                "What security features do your properties have?",
                "Do you have any eco-friendly or green properties?",
                "What payment methods do you accept?",
                "Can I pay for a property in installments?",
                "Do you offer any discounts for cash payments?",
                "How much deposit is required to secure a property?",
                "What are the terms for mortgage financing?",
                "Do you have partnerships with any banks for home loans?",
                "What happens if I can't complete my payments?",
                "Are there any hidden fees when buying property?",
                "Can I get a refund if I change my mind after paying a deposit?",
                "What is the process for making an offer on a property?",
                "What are the best areas to invest in Nairobi?",
                "Tell me about properties in Karen",
                "What's the average price per square meter in Kilimani?",
                "Which areas have the best schools nearby?",
                "Are there any beachfront properties available?",
                "Which locations are best for young professionals?",
                "What areas have the best rental returns?",
                "Tell me about upcoming neighborhoods with growth potential",
                "Which areas have the best infrastructure?",
                "Are there any gated communities available?",
                "What is the process for land title verification?",
                "How do I know if a property has clean title?",
                "What are the land zoning regulations in Nairobi?",
                "Can foreigners own land in Kenya?",
                "What is the difference between leasehold and freehold land?",
                "How long does property transfer take in Kenya?",
                "What legal documents should I review before buying property?",
                "Are there restrictions on property use in certain areas?",
                "What happens if there's a dispute over property boundaries?",
                "How do I check for any encumbrances on a property?",
                "Do you offer property management services?",
                "What maintenance services are included for apartments?",
                "How are service charges calculated for apartments?",
                "Who handles repairs in rental properties?",
                "Do you help with finding tenants for investment properties?",
                "What is your tenant screening process?",
                "How often is maintenance performed on properties?",
                "What happens if there's a major repair needed?",
                "Do you handle utility connections for new properties?",
                "How do you handle security for properties?",

            ],
            "answers": [
                "You can schedule a property viewing by contacting our agents via phone or email.",
                "To buy a house, you need identification, proof of income, and a signed sale agreement.",
                "The price range for houses in Nyeri varies between KES 5M and KES 50M.",
                "You can verify a title deed at the local land registry to ensure ownership legitimacy.",
                "Buying land involves due diligence, title deed verification, and legal paperwork.",
                "Yes, we have several rental apartments in Eldoret with different price ranges.",
                "When choosing an agent, consider their experience, reputation, and market knowledge.",
                "The legal requirements include title deed verification, contract signing, and land registry checks.",
                "Yes, we provide virtual tours to help you view properties remotely.",
                "Factors affecting property value include location, infrastructure, and demand trends.",
                "Yes, property prices are often negotiable depending on market conditions and seller preferences.",
                "Investment potential in Machakos is high due to infrastructure development and economic growth.",
                "We offer financing options including mortgages and installment payment plans.",
                "Monthly mortgage payments depend on the loan amount, interest rate, and loan tenure.",
                "Home loan interest rates typically range from 9% to 13% per annum.",
                "To buy property, you need identification documents, proof of income, and will need to sign a sale agreement. Our agents can guide you through the entire process. Would you like to know about specific properties?",
                "To purchase a house, you\'ll need identification, proof of income, and to sign a sale agreement. The process typically involves property viewing, making an offer, securing financing, and completing legal paperwork.",
                "The property buying process involves identifying a property, making an offer, securing financing, conducting inspections, and completing legal paperwork. Our agents can assist you at every step.",
                "To buy a house, you need identification documents, proof of income, and a signed sale agreement. You\'ll also need a down payment (typically 10-20% of the property value) and mortgage approval if financing.",
                "Documents needed for property purchase include national ID/passport, KRA PIN, proof of income (bank statements or payslips), and marriage certificate if applicable. You\'ll also sign a sale agreement.",
                "The house buying process involves property viewing, price negotiation, paying a deposit, securing financing, conducting due diligence, signing the sale agreement, and transferring ownership.",
                "Great! Our properties range from KES 3.5 million to KES 45 million. Would you like to know about specific locations or property types that match your budget?",
                "With 1 million KES, you could make a down payment on several of our properties. This would typically be a 10-20% deposit on properties valued between KES 5-10 million. Would you like to see specific options?",
                "With 1 million KES as a 10% deposit, you could qualify for properties around KES 10 million. This includes 2-bedroom apartments in Westlands or Kilimani. Would you like to see available options?",
                "With 1 million KES, you could make a down payment on an apartment or land. For example, we have a plot in Kitengela for KES 3.5 million where your 1 million would cover almost 30% of the cost.",
                "We have properties in various locations including Kilimani, Westlands, Karen, Nairobi CBD, South B, Langata, and Kitengela. Would you like more specific information about any of these areas?",
                "Our properties are located in prime areas of Nairobi including Kilimani, Westlands, Karen, and the CBD. We also have land in Kitengela. For a budget of around 10 million, Westlands and South B offer good options. Would you like to see specific listings?",
                "We have houses and apartments in Kilimani, Westlands, Karen, South B, Langata, and the CBD. We also have land in Kitengela. With a budget of 10 million, you could afford a nice 2-bedroom apartment in Westlands or South B. Would you like to see available options?",
                "For a budget of 10 million KES, we have 2-bedroom apartments in Westlands starting at 9.5 million and in South B starting at 8.5 million. These are in good locations close to shopping centers and restaurants. Would you like to see specific listings?",
                "With 10 million KES, you can purchase a 2-bedroom apartment in Westlands or South B. These apartments are well-located with modern finishes. Would you like to see the available options?",
                "Yes, besides Westlands and South B, you might also consider Langata where your 10 million budget could get you a smaller 3-bedroom house. Would you like more information about these areas?",
                "With 10 million KES, you can purchase property in Westlands (2-bedroom apartments), South B (2-bedroom apartments), or Langata (smaller 3-bedroom houses). Would you like to see specific listings in any of these areas?",
                "With 10 million KES, you can buy property in Westlands, South B, Langata, or parts of Kileleshwa. The most value for money would be in Westlands where we have modern 2-bedroom apartments for 9.5 million. Would you like to see these options?",
                "Areas with properties around 10 million include Westlands, South B, Langata, and parts of Kileleshwa. The type of property varies by location - apartments in Westlands and South B, and possibly small houses in Langata.",
                "For properties around 10 million, look at Westlands (2-bedroom apartments for 9.5M), South B (2-bedroom apartments for 8.5M), and Langata (smaller 3-bedroom houses for around 12M). Would you like to see specific listings in any of these areas?",
                "Yes, we have several properties for sale in Kitengela with different price ranges.",
                "Yes, we offer short-term rental properties for business and leisure stays.",
                "Rental property ROI in Nakuru averages between 6% and 12% annually.",
                "Market value is determined by location, property size, condition, and demand.",
                "The home buying process typically takes 30 to 90 days, depending on financing and paperwork.",
                "You can list your property for sale with Kwetu Homes by submitting details through our website.",
                "Kwetu Homes properties feature amenities such as security, parking, swimming pools, and gardens.",
                "Additional costs may include legal fees, stamp duty, and maintenance charges.",
                "Yes, we provide rental and property management services.",
                "The home buying process typically takes 30 to 90 days, depending on financing and paperwork.",
                "Kwetu Homes offers apartments, townhouses, and standalone houses.",
                "Yes, we offer installment payment plans for home buyers.",
                "To rent a home, visit our website, choose a property, and complete the application process.",
                "Yes, we assist buyers in securing mortgage financing.",
                "Legal steps include signing a sale agreement, title deed verification, and land registry submission.",
                "Yes, Kwetu Homes sells land in various locations.",
                "Investing in real estate provides passive income, asset appreciation, and financial security.",
                "You can check ownership history at the land registry.",
                "Consider location, developer reputation, and amenities before buying an apartment.",
                "The average rental yield in Nairobi ranges from 5% to 10% per year.",
                "If you default on mortgage payments, the lender may repossess your property.",
                "Yes, Kwetu Homes offers both furnished and unfurnished apartments.",
                "Yes, first-time buyers may be eligible for discounts and promotional offers.",
                "Property transfer requires a signed agreement, title deed, and registration with the land office.",
                "Kwetu Homes estates include CCTV, perimeter walls, and 24/7 security.",
                "Yes, Kwetu Homes has upcoming developments in various locations.",
                "Yes, we assist homeowners in reselling their properties.",
                "A minimum deposit of 10-20% is typically required to buy a property.",
                "Yes, we provide rental management services, including tenant screening and rent collection.",
                "Required documents include identification, bank statements, and proof of income.",
                "Improve your property value by renovating, repainting, and landscaping.",
                "Yes, foreigners can buy property in Kenya, but with some restrictions on land ownership.",
                "Property prices are influenced by market demand, economic conditions, and location.",
                "To confirm legal registration, check with the Ministry of Lands or hire a lawyer.",
                "Kenya has both freehold and leasehold land tenure systems.",
                "Property taxes in Kenya include stamp duty (2-4%), capital gains tax (5%), and annual land rates. Consult with a tax advisor for personalized advice.",
                "Calculate ROI by dividing annual rental income (minus expenses) by the total property investment cost, then multiply by 100 to get a percentage.",
                "Areas with the highest appreciation rates include Nairobi\"s Westlands, Kilimani, Karen, and emerging areas like Kitengela and Syokimau due to infrastructure development.",
                "Real estate investment risks include market fluctuations, liquidity challenges, property damage, tenant issues, and regulatory changes. Diversification can help mitigate these risks.",
                "Good investment properties have favorable location, strong rental demand, good condition, reasonable price, potential for appreciation, and positive cash flow.",
                "Freehold means you own the land and building indefinitely. Leasehold means you have rights to the property for a fixed period, after which ownership reverts to the freeholder.",
                "Due diligence includes verifying ownership documents, checking for encumbrances, confirming zoning regulations, inspecting the property, and researching the neighborhood.",
                "Current mortgage interest rates range from 11.5% to 15% depending on the lender, loan amount, and your credit profile.",
                "To qualify for a mortgage, you typically need stable income, good credit history, a down payment (usually 10-20%), and a debt-to-income ratio below 40%.",
                "Real estate agents provide market expertise, negotiation skills, access to listings, paperwork handling, and guidance throughout the buying or selling process.",
                "Compare similar properties in the area (comps), consider price per square foot, evaluate amenities, and consult recent sales data to determine if a price is fair.",
                "Hidden costs include legal fees (1-2%), stamp duty (2-4%), valuation fees, land rent, insurance, maintenance, and possibly homeowner association fees.",
                "Real estate is typically a medium to long-term investment. Expect to hold property for at least 3-5 years to see significant appreciation in most markets.",
                "Kitchen and bathroom renovations typically offer the best ROI, followed by adding usable space, improving energy efficiency, and enhancing curb appeal.",
                "Handle property disputes by first discussing the issue directly, consulting property documents, seeking mediation, and as a last resort, pursuing legal action.",
                "To buy property, you need identification documents, proof of income, and will need to sign a sale agreement. Our agents can guide you through the entire process. Would you like to know about specific properties?",
                "To purchase a house, you\'ll need identification, proof of income, and to sign a sale agreement. The process typically involves property viewing, making an offer, securing financing, and completing legal paperwork.",
                "The property buying process involves identifying a property, making an offer, securing financing, conducting inspections, and completing legal paperwork. Our agents can assist you at every step.",
                "To buy a house, you need identification documents, proof of income, and a signed sale agreement. You\'ll also need a down payment (typically 10-20% of the property value) and mortgage approval if financing.",
                "Documents needed for property purchase include national ID/passport, KRA PIN, proof of income (bank statements or payslips), and marriage certificate if applicable. You\'ll also sign a sale agreement.",
                "The house buying process involves property viewing, price negotiation, paying a deposit, securing financing, conducting due diligence, signing the sale agreement, and transferring ownership.",
                "Great! Our properties range from KES 3.5 million to KES 45 million. Would you like to know about specific locations or property types that match your budget?",
                "Here are some specific options in our portfolio:\n\n1. Modern 2 Bedroom Apartment - KES 9,500,000\nLocation: Westlands, near Sarit Centre\nFeatures: 85 sq.m, 1 bathroom, modern finishes\n\n2. 2 Bedroom Apartment in South B - KES 8,500,000\nLocation: South B, Nairobi\nFeatures: 80 sq.m, 1 bathroom, family-friendly neighborhood\n\n3. 3 Bedroom House in Langata - KES 12,000,000\nLocation: Langata, near Nairobi National Park\nFeatures: 150 sq.m, 2 bathrooms, small garden\n\nWould you like to schedule a viewing for any of these properties?",
                "Id be happy to share some options with you. Here are three properties that might interest you:\n\n1. 2 Bedroom Apartment in Westlands - KES 9,500,000\nModern finishes, close to shopping centers, 85 sq.m\n\n2. 2 Bedroom Apartment in South B - KES 8,500,000\nFamily-friendly area, good security, 80 sq.m\n\n3. 3 Bedroom House in Langata - KES 12,000,000\nQuiet neighborhood, small garden, 150 sq.m\n\nWould you like more information about any of these properties?",
                "Here are some available properties in our portfolio:\n\n1. Modern 2 Bedroom Apartment in Westlands - KES 9,500,000\n2. 2 Bedroom Apartment in South B - KES 8,500,000\n3. 3 Bedroom House in Langata - KES 12,000,000\n4. 1/4 Acre Plot in Kitengela - KES 3,500,000\n\nEach property has different features and amenities. Would you like more details about any specific property?",
                "Id be happy to tell you more about our properties. Our current listings include apartments in Westlands and South B starting from KES 8.5 million, houses in Langata from KES 12 million, and land in Kitengela from KES 3.5 million. All our properties are in secure locations with good infrastructure. Would you like specific details about any of these areas?",
                "We have several options available. In Westlands, we have a 2-bedroom apartment for KES 9.5M. In South B, we have a similar 2-bedroom unit for KES 8.5M. For those looking for a house, we have a 3-bedroom in Langata for KES 12M. We also have land in Kitengela starting at KES 3.5M. Which of these would you like more information about?",
                "Here are some listings you might be interested in:\n\n1. Westlands: 2BR apartment, 85 sq.m, KES 9.5M\n2. South B: 2BR apartment, 80 sq.m, KES 8.5M\n3. Langata: 3BR house, 150 sq.m, KES 12M\n4. Kitengela: 1/4 acre plot, KES 3.5M\n\nAll properties are in secure locations with good amenities. Would you like to schedule a viewing?",
                "I'd be happy to share more details. Our Westlands apartment (KES 9.5M) features modern finishes, 24-hour security, and is close to Sarit Centre. The South B apartment (KES 8.5M) is in a family-friendly compound with a playground. The Langata house (KES 12M) has a small garden and is in a quiet neighborhood. Which property interests you most?",
                "Here's what we currently have available:\n\n- Westlands: Modern 2BR apartment, KES 9.5M\n- South B: Spacious 2BR apartment, KES 8.5M\n- Langata: Cozy 3BR house with garden, KES 12M\n- Kitengela: 1/4 acre plot with good access road, KES 3.5M\n\nAll residential properties come with parking, security, and water storage. Would you like to know more about any specific property?",
                "Here are some specific properties in our portfolio:\n\n1. Westlands 2BR Apartment (KES 9.5M): Located near Sarit Centre, modern finishes, 85 sq.m, 1 bathroom, 24-hour security.\n\n2. South B 2BR Apartment (KES 8.5M): Family-friendly area, 80 sq.m, 1 bathroom, close to Mombasa Road.\n\n3. Langata 3BR House (KES 12M): Near Nairobi National Park, 150 sq.m, 2 bathrooms, small garden, quiet neighborhood.\n\nWould you like to schedule a viewing?",
                "I'm happy to show you our available options. We have:\n\n1. A modern 2-bedroom apartment in Westlands for KES 9.5M\n2. A well-maintained 2-bedroom apartment in South B for KES 8.5M\n3. A cozy 3-bedroom house in Langata for KES 12M\n4. A 1/4 acre plot in Kitengela for KES 3.5M\n\nEach property has its unique features and benefits. Which one would you like more information about?",
                "In Westlands, we have modern 1, 2, and 3-bedroom apartments in secure compounds. Most units feature contemporary finishes, ample parking, and 24-hour security. Prices range from KES 8.5M to KES 15M depending on size and specific location within Westlands.",
                "Our 2-bedroom apartment in Westlands is an excellent choice. Located near Sarit Centre, it features modern finishes, 1 bathroom, and spans 85 square meters. The property is priced at KES 9,500,000 and is in a secure compound with 24-hour security and parking. Would you like to schedule a viewing?",
                "The Westlands apartment includes amenities such as 24-hour security, reserved parking, water storage tanks, high-speed internet connectivity, and a communal garden. The building also has backup power and is located within walking distance to shopping centers and restaurants.",
                "Yes, several of our properties in Karen and Kilimani feature swimming pools. Our luxury apartments in Kilimani (starting at KES 18M) include access to a communal pool, while some of our standalone houses in Karen have private pools.",
                "Yes, most of our properties come with backup generators or inverter systems to ensure continuous power supply. This is a standard feature in our mid to high-end properties, particularly in areas like Kilimani, Westlands, and Karen.",
                "Yes, we do have pet-friendly properties, primarily in Karen and parts of Langata. These properties typically have more space and garden areas. Please note that some apartments may have restrictions on pets, so its best to inquire about specific properties.",
                "Yes, our properties in Karen, Langata, and some in Kilimani come with garden spaces. The standalone houses typically have private gardens, while some apartment complexes feature communal garden areas for residents.",
                "Several of our apartment complexes in Kilimani and Westlands feature communal gyms for residents. Our premium development in Kilimani offers a fully-equipped modern gym, swimming pool, and children's play area.",
                "All our properties prioritize security with features such as perimeter walls, electric fencing, CCTV surveillance, 24-hour security personnel, and secure access gates. Higher-end properties may also include alarm systems and panic buttons.",
                "We have several eco-friendly properties that incorporate solar water heating, rainwater harvesting systems, energy-efficient lighting, and natural ventilation. Our newest development in Kilimani is built to green building standards with sustainable materials and energy-efficient design.",
                "We accept various payment methods including bank transfers, banker's checks, and mobile money for smaller amounts. For international buyers, we also accept wire transfers. All payments should be made to our official company accounts only.",
                "Yes, we offer installment payment plans for select properties. Typically, this involves a 30% down payment followed by structured payments over 6-24 months, depending on the property and agreement terms. Interest may apply for longer payment periods.",
                "Yes, we offer discounts of 3-5% for full cash payments on select properties. This varies by property and current promotions. Cash buyers also benefit from a faster closing process and reduced paperwork.",
                "The standard deposit to secure a property is 10% of the purchase price. This deposit is non-refundable unless there are issues with the property title or other legal complications on the seller's side.",
                "Mortgage financing typically requires a 10-20% down payment, with repayment terms ranging from 5 to 25 years. Interest rates currently range from 11.5% to 15% depending on the lender and your credit profile. We can assist you in connecting with mortgage providers.",
                "Yes, we have partnerships with several banks including Equity Bank, KCB, Stanbic, and Co-operative Bank. These partnerships often provide preferential rates and faster processing for our clients. Our team can help you with the application process.",
                "If you're unable to complete payments as agreed, we first try to work out a revised payment plan. If that's not feasible, you may forfeit a portion of your deposit based on the terms in the sale agreement. Each case is handled individually to find the best solution.",
                "Beyond the property price, buyers should budget for legal fees (1-2%), stamp duty (2-4%), valuation fees (KES 10,000-25,000), land rent and rates (varies by location), and possibly agent commission if applicable. We provide a full breakdown of costs before you commit.",
                "Deposits are generally non-refundable as they secure the property and take it off the market. However, if there are title issues or the seller fails to meet contractual obligations, you would be entitled to a full refund. This is detailed in the sale agreement.",
                "To make an offer, you'll need to complete an offer form specifying your price and any conditions. This is submitted with a booking fee (typically KES 50,000-100,000). If accepted, you'll proceed to pay the deposit and sign a sale agreement. Our agents guide you through each step.",
                "The best investment areas in Nairobi currently include Kilimani, Westlands, and Karen for high-end properties, while Syokimau, Athi River, and Kitengela offer good growth potential at lower price points. Emerging areas like Ngong and Kikuyu are also showing promising returns due to infrastructure development.",
                "Karen is an upscale residential area known for its spacious properties and serene environment. Properties here range from luxury villas to modern townhouses, typically on larger plots with mature gardens. Prices range from KES 45M for townhouses to KES 150M+ for luxury villas. The area offers excellent international schools, shopping centers, and restaurants.",
                "In Kilimani, the average price per square meter ranges from KES 120,000 to KES 180,000 for apartments, depending on the specific location, building age, and amenities. Newer developments with premium amenities command higher prices, while older apartments offer better value for money.",
                "Karen, Lavington, and Gigiri are known for proximity to top international schools like ISK, Braeburn, and German School. For national schools, areas near Westlands, Kileleshwa, and parts of South B offer good access to reputable institutions. We can provide specific school information for any property you're interested in.",
                "Yes, we have beachfront properties available along the Kenyan coast, primarily in Diani, Nyali, and Malindi. These range from apartments starting at KES 15M to luxury villas at KES 80M+. These properties offer excellent rental potential during tourist seasons and are popular as holiday homes.",
                "Westlands, Kilimani, and Lavington are ideal for young professionals, offering modern apartments close to business districts, shopping malls, restaurants, and entertainment spots. These areas have good transport links and a vibrant social scene. Prices start from KES 8.5M for 1-bedroom apartments.",
                "Kilimani, Westlands, and South B currently offer the best rental returns in Nairobi, with yields ranging from 7-10% annually. Student housing near universities and small apartments in Westlands tend to perform particularly well. Emerging areas like Ruaka and Kikuyu are also showing strong rental potential.",
                "Neighborhoods with significant growth potential include Kangemi, Ruaka, Athi River, and parts of Machakos County. These areas are benefiting from improved infrastructure, new bypass roads, and spillover demand from more expensive neighboring areas. Early investors in these locations typically see strong capital appreciation over 3-5 years.",
                "Westlands, Kilimani, and Karen currently have the best infrastructure in terms of roads, water supply, internet connectivity, and power stability. The Thika Road corridor has also seen significant improvements with the superhighway development. Upcoming areas like Tatu City are being built with world-class infrastructure from the ground up.",
                "Yes, we have several gated communities available, particularly in Karen, Kitisuru, and Runda. These offer enhanced security, community amenities like clubhouses and playgrounds, and often have homeowner associations that maintain common areas. Prices in these communities typically start from KES 35M for townhouses and can exceed KES 100M for standalone homes.",
                "Land title verification involves conducting an official search at the lands registry, reviewing the title deed history, confirming boundary details, and checking for any encumbrances or restrictions. We recommend using a registered lawyer for this process, which typically takes 7-14 days.",
                "A property has clean title when it has no liens, encumbrances, or legal issues that could affect ownership rights. To verify this, conduct an official search at the lands registry, check for any caveats or restrictions, verify that rates and land rent are paid up, and ensure there are no pending disputes. Our legal team can assist with this verification process.",
                "Nairobi is divided into various zoning areas that regulate property use, including residential, commercial, industrial, and mixed-use zones. Each zone has specific regulations regarding building height, plot ratio, and permitted activities. Before purchasing, we verify that the property's current and intended use complies with local zoning regulations.",
                "Foreigners can own property in Kenya but with certain restrictions. They can purchase apartments and buildings but cannot own freehold land directly. Foreigners can hold leasehold land for up to 99 years. Foreign companies with Kenyan registration can own property if the majority shareholding is by Kenyan citizens.",
                "Freehold ownership gives you absolute rights to the land without time limitations, allowing you to use, transfer, or develop it as you wish (subject to zoning laws). Leasehold ownership grants you rights to use the land for a specific period (typically 33, 66, or 99 years), after which it reverts to the freeholder unless renewed. Most urban properties in Kenya are leasehold.",
                "Property transfer in Kenya typically takes 60-90 days from signing the sale agreement to receiving the new title deed. This includes conducting searches (7-14 days), paying stamp duty (depends on processing time), lodging transfer documents (30 days), and receiving the new title (14-30 days). Delays can occur if there are issues with the title or documentation.",
                "Before buying property, you should review the title deed, land search certificate, approved architectural plans, occupation certificate, land rent receipts, land rates receipts, seller's KRA PIN, consent to transfer (for leasehold), and the sale agreement. For apartments, also review the sectional plan and management agreements. Our legal team provides comprehensive document review services.",
                "Yes, there are restrictions on property use based on zoning regulations. For example, you cannot operate a commercial business in a purely residential zone without proper approvals. Some areas also have restrictions on building height, density, and architectural style. We verify all restrictions before recommending a property for purchase.",
                "Boundary disputes are resolved through a formal resurvey by a licensed surveyor, often with the involvement of the land registrar. If the dispute persists, it may require mediation or court proceedings. To avoid such issues, we recommend conducting a proper survey and boundary verification before completing any property purchase.",
                "To check for encumbrances, conduct an official search at the lands registry, which will reveal any registered charges, caveats, restrictions, or ongoing disputes. You should also verify that all land rates and rent are paid up to date. Our due diligence process includes a comprehensive encumbrance check to ensure you're purchasing a clean title.",
                "Yes, we offer comprehensive property management services for both individual properties and entire developments. Our services include tenant sourcing and screening, rent collection, maintenance coordination, financial reporting, and regular property inspections. Our management fee typically ranges from 7-10% of the rental income.",
                "For apartments, maintenance services typically include common area cleaning, garbage collection, security services, gardening for common areas, maintenance of shared facilities (pools, gyms, etc.), and building exterior maintenance. Individual unit maintenance is usually the owner's responsibility unless specified otherwise in the management agreement.",
                "Service charges for apartments are calculated based on the size of your unit (square footage) as a proportion of the total building area. These charges cover common area maintenance, security, garbage collection, and other shared services. Charges typically range from KES 35-80 per square foot per month, depending on the building's amenities and location.",
                "For rental properties under our management, we coordinate all repairs. Minor repairs (under KES 10,000) are typically handled without owner approval, while major repairs require authorization. The cost is either deducted from rental income or billed separately. We maintain a network of reliable contractors to ensure quality work at competitive prices.",
                "Yes, we provide comprehensive tenant sourcing services for investment properties. This includes marketing the property, conducting viewings, screening potential tenants, preparing lease agreements, and handling the move-in process. Our tenant placement fee is typically equivalent to one month's rent for a one-year lease.",
                "Our tenant screening process includes background checks, credit history review, employment verification, previous landlord references, and in-person interviews. We verify income to ensure it's at least three times the monthly rent. This thorough process helps secure reliable, long-term tenants who will care for your property.",
                "We conduct quarterly routine maintenance inspections for all managed properties. Preventive maintenance for systems like HVAC, plumbing, and electrical is scheduled based on manufacturer recommendations, typically semi-annually. Common areas in apartment buildings receive weekly maintenance. We also respond promptly to any maintenance requests from tenants.",
                "For major repairs, we first assess the issue and provide you with a detailed report and cost estimate. Upon your approval, we coordinate with qualified contractors, oversee the work, and ensure it meets quality standards. For emergency repairs that affect habitability or safety, we may proceed immediately and notify you as soon as possible.",
                "Yes, we assist with utility connections for new properties, including electricity, water, internet, and security systems. We coordinate with service providers to ensure everything is set up before you move in or before tenants occupy the property. We can also help transfer existing utilities to new owners or tenants.",
                "Security for our properties includes a combination of physical security (guards, access control systems, perimeter walls) and technology (CCTV, alarm systems, motion sensors). For high-end properties, we may also implement biometric access and panic buttons. We regularly review and update security measures based on current needs and emerging technologies."

            ]
        };

        // Greeting responses
        const greetingResponses = [
            "Hello! How can I assist you with your real estate needs today?",
            "Hi there! Welcome to Kwetu Homes. How can I help you?",
            "Good day! I'm here to answer your real estate questions. What would you like to know?",
            "Hey! Looking for property information? I'm here to help!"
        ];

        // Follow-up response for when user asks to see specific options
        const specificOptionsResponse = "Here are some specific options in our portfolio:\n\n1. Modern 2 Bedroom Apartment - KES 9,500,000\nLocation: Westlands, near Sarit Centre\nFeatures: 85 sq.m, 1 bathroom, modern finishes\n\n2. 2 Bedroom Apartment in South B - KES 8,500,000\nLocation: South B, Nairobi\nFeatures: 80 sq.m, 1 bathroom, family-friendly neighborhood\n\n3. 3 Bedroom House in Langata - KES 12,000,000\nLocation: Langata, near Nairobi National Park\nFeatures: 150 sq.m, 2 bathrooms, small garden\n\nWould you like to schedule a viewing for any of these properties?";

        // Sample property data
        const properties = [
            {
                id: 1,
                title: 'Modern 3 Bedroom Apartment',
                location: 'Kilimani, Nairobi',
                price: 15000000,
                bedrooms: 3,
                bathrooms: 2,
                size: 120,
                type: 'Apartment',
                description: 'Luxurious 3 bedroom apartment with modern finishes, spacious living area, and balcony with city views.',
                image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8YXBhcnRtZW50fGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60'
            },
            {
                id: 2,
                title: '4 Bedroom Villa with Garden',
                location: 'Karen, Nairobi',
                price: 45000000,
                bedrooms: 4,
                bathrooms: 3,
                size: 300,
                type: 'Villa',
                description: 'Spacious family home with large garden, swimming pool, and modern kitchen. Located in a secure gated community.',
                image: 'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8aG91c2V8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60'
            },
            {
                id: 3,
                title: '2 Bedroom Apartment',
                location: 'Westlands, Nairobi',
                price: 9500000,
                bedrooms: 2,
                bathrooms: 1,
                size: 85,
                type: 'Apartment',
                description: 'Cozy 2 bedroom apartment with modern finishes, close to shopping centers and restaurants.',
                image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTd8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60'
            },
            {
                id: 4,
                title: 'Commercial Space',
                location: 'CBD, Nairobi',
                price: 25000000,
                bedrooms: 0,
                bathrooms: 2,
                size: 200,
                type: 'Commercial',
                description: 'Prime commercial space in Nairobi CBD, suitable for office or retail use.',
                image: 'https://images.unsplash.com/photo-1497366754035-f200968a6e72?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8b2ZmaWNlJTIwc3BhY2V8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60'
            },
            {
                id: 5,
                title: '1/4 Acre Plot',
                location: 'Kitengela, Kajiado',
                price: 3500000,
                bedrooms: 0,
                bathrooms: 0,
                size: 1011,
                type: 'Land',
                description: 'Ready for development plot with all utilities and good access road.',
                image: 'https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bGFuZHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60'
            },
            {
                id: 6,
                title: '2 Bedroom Apartment in South B',
                location: 'South B, Nairobi',
                price: 8500000,
                bedrooms: 2,
                bathrooms: 1,
                size: 80,
                type: 'Apartment',
                description: 'Well-maintained 2 bedroom apartment in a family-friendly neighborhood with good security and amenities.',
                image: 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGFwYXJ0bWVudHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60'
            },
            {
                id: 7,
                title: '3 Bedroom House in Langata',
                location: 'Langata, Nairobi',
                price: 12000000,
                bedrooms: 3,
                bathrooms: 2,
                size: 150,
                type: 'House',
                description: 'Spacious 3 bedroom house with a small garden in a quiet neighborhood, close to Nairobi National Park.',
                image: 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8aG91c2V8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60'
            }
        ];
        // Enhanced context management
        let conversationContext = {
            topic: null,        // Current topic (buying, viewing, financing, etc.)
            budget: null,       // User's mentioned budget
            propertyType: null, // Type of property user is interested in
            location: null,     // Location user is interested in
            lastQuestion: null, // Last question asked by user
            lastAnswer: null    // Last answer provided by bot
        };

        // Update context based on user message
        function updateContext(userMessage, matchedQuestion, answer) {
            // Preserve previous context
            const previousContext = {...conversationContext};
            
            // Extract budget if mentioned
            const budgetMatch = userMessage.match(/(\d+)(?:\s*million|\s*m|\s*k)/i);
            if (budgetMatch) {
                conversationContext.budget = parseInt(budgetMatch[1]);
            }
            
            // Update topic based on keywords
            if (userMessage.match(/buy|purchase|invest/i)) {
                conversationContext.topic = 'buying';
            } else if (userMessage.match(/rent|lease/i)) {
                conversationContext.topic = 'renting';
            } else if (userMessage.match(/view|tour|visit/i)) {
                conversationContext.topic = 'viewing';
            } else if (userMessage.match(/financ|mortgage|loan|payment/i)) {
                conversationContext.topic = 'financing';
            } else if (userMessage.match(/locat|area|where/i)) {
                conversationContext.topic = 'location';
            } else if (userMessage.match(/propert|house|apartment|home/i) && !conversationContext.topic) {
                conversationContext.topic = 'properties';
            }
            
            // Extract property type if mentioned
            if (userMessage.match(/apartment|flat/i)) {
                conversationContext.propertyType = 'apartment';
            } else if (userMessage.match(/house|home/i)) {
                conversationContext.propertyType = 'house';
            } else if (userMessage.match(/land|plot/i)) {
                conversationContext.propertyType = 'land';
            }
            
            // Extract location if mentioned
            const locations = ['westlands', 'kilimani', 'karen', 'south b', 'langata', 'kitengela', 'nairobi'];
            for (const location of locations) {
                if (userMessage.toLowerCase().includes(location)) {
                    conversationContext.location = location;
                    break;
                }
            }
            
            // Update last question and answer
            conversationContext.lastQuestion = matchedQuestion;
            conversationContext.lastAnswer = answer;
            
            console.log("Context updated:", conversationContext);
            return previousContext;
        }

        // DOM elements
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const suggestionBtns = document.querySelectorAll('.suggestion-btn');
        const chatLink = document.getElementById('chat-link');
        const searchLink = document.getElementById('search-link');
        const chatView = document.getElementById('chat-view');
        const searchView = document.getElementById('search-view');
        const searchBtn = document.getElementById('search-btn');
        const propertyResults = document.getElementById('property-results');
        const resetChatBtn = document.getElementById('reset-chat');
        const toggleSuggestionsBtn = document.getElementById('toggle-suggestions');
        
        // Find the search properties and schedule viewing buttons
        const searchPropertiesBtn = document.getElementById('search-properties-btn');
        const scheduleViewingBtn = document.getElementById('schedule-viewing-btn');

        // Last context for follow-up questions
        let lastContext = null;
        
        // Flag to track if a response is being processed
        let isProcessingResponse = false;

        // Check if user is a first-time visitor
        checkFirstTimeVisitor();

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing-indicator-container';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatBox.appendChild(typingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return typingDiv;
        }

        // Function to format a message with links and structured content
        function formatMessage(message) {
            if (!message) {
                console.error("Attempted to format undefined or empty message");
                return "I'm sorry, I couldn't generate a response. Please try asking again.";
            }
            
            try {
                // Convert URLs to clickable links
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                let formattedMessage = message.replace(urlRegex, function(url) {
                    return `<a href="${url}" target="_blank">${url}</a>`;
                });
                
                // Replace newlines with <br>
                formattedMessage = formattedMessage.replace(/\n/g, '<br>');
                
                // Highlight property prices for better visibility
                formattedMessage = formattedMessage.replace(/KES (\d{1,3}(,\d{3})*(\.\d+)?)/g, 
                    '<span style="font-weight: bold; color: var(--accent-color);">KES \$1</span>');
                
                return formattedMessage;
            } catch (error) {
                console.error("Error formatting message:", error);
                return message || "Error formatting message";
            }
        }

        // Function to check if a message is a greeting
        function isGreeting(message) {
            if (!message) return false;
            
            const greetings = ['hi', 'hello', 'hey', 'howdy', 'hola', 'greetings', 'good morning', 'good afternoon', 'good evening'];
            message = message.toLowerCase().trim();
            
            for (const greeting of greetings) {
                if (message === greeting || message === greeting + '!' || message === greeting + '.') {
                    return true;
                }
                
                const greetingPhrases = [
                    greeting + ' there',
                    greeting + ' how are you',
                    greeting + ' how are you doing',
                    greeting + ' how is it going',
                    greeting + ' kwetu',
                    greeting + ' team'
                ];
                
                if (greetingPhrases.some(phrase => message.startsWith(phrase))) {
                    return true;
                }
            }
            
            return false;
        }

        // Function to check if a message is a follow-up
        function isFollowUp(message) {
            if (!message) return false;
            
            const followUpPhrases = [
                'yes', 'yeah', 'sure', 'please', 'ok', 'okay', 'show me', 'tell me more', 
                'more information', 'more details', 'specific', 'options', 'share', 'show'
            ];
            
            message = message.toLowerCase().trim();
            
            for (const phrase of followUpPhrases) {
                if (message.startsWith(phrase) || message === phrase) {
                    return true;
                }
            }
            
            return false;
        }

        // Function to calculate similarity between two strings
        function calculateSimilarity(query, document) {
            if (!query || !document) return 0;
            
            try {
                // Simple implementation - count matching words and n-grams
                const queryWords = query.toLowerCase().split(/\s+/);
                const docWords = document.toLowerCase().split(/\s+/);

                // Real estate specific keywords that should have higher weight
                const importantKeywords = [
                    'property', 'house', 'apartment', 'mortgage', 'loan', 'buy', 'purchase',
                    'rent', 'price', 'cost', 'deposit', 'down payment', 'location', 'area',
                    'bedroom', 'bathroom', 'square', 'meter', 'acre', 'land', 'agent', 'broker',
                    'fee', 'commission', 'contract', 'agreement', 'title', 'deed', 'document',
                    'inspection', 'appraisal', 'valuation', 'insurance', 'tax', 'interest', 'rate',
                    'million', 'shilling', 'kes', 'options', 'specific', 'westlands', 'kilimani',
                    'karen', 'kitengela', 'nairobi', 'cbd', 'south', 'langata', 'available', 'where'
                ];

                let matches = 0;
                let totalWeight = queryWords.length || 1; // Avoid division by zero

                // Word matching
                for (const word of queryWords) {
                    if (docWords.includes(word)) {
                        // Give more weight to important keywords
                        if (importantKeywords.includes(word)) {
                            matches += 2;
                            totalWeight += 1;
                        } else {
                            matches += 1;
                        }
                    }
                }
                
                // Check for bigrams (pairs of words) for better phrase matching
                if (queryWords.length > 1) {
                    for (let i = 0; i < queryWords.length - 1; i++) {
                        const queryBigram = queryWords[i] + ' ' + queryWords[i+1];
                        for (let j = 0; j < docWords.length - 1; j++) {
                            const docBigram = docWords[j] + ' ' + docWords[j+1];
                            if (queryBigram === docBigram) {
                                matches += 2; // Bigram matches are more significant
                            }
                        }
                    }
                }
                
                // Check if query is contained in document or vice versa
                const queryText = queryWords.join(' ');
                const docText = docWords.join(' ');
                if (docText.includes(queryText)) {
                    matches += queryWords.length; // Significant boost for full inclusion
                } else if (queryText.includes(docText)) {
                    matches += docWords.length;
                }

                return matches / (totalWeight + 2); // +2 to normalize the score a bit
            } catch (error) {
                console.error("Error calculating similarity:", error);
                return 0;
            }
        }

        // Function to find the best matching question
        function findBestMatch(userMessage) {
            if (!userMessage || !userMessage.trim()) {
                return {
                    question: "empty",
                    answer: "I didn't catch that. Could you please ask a question about our properties, buying process, or mortgage options?",
                    score: 0
                };
            }
            
            try {
                // Normalize user message
                const normalizedUserMessage = userMessage.toLowerCase().trim();
                
                // Check for direct property availability questions
                if (normalizedUserMessage.match(/which properties|what properties|available properties|properties available|show properties/i)) {
                    const answer = getAvailablePropertiesResponse();
                    updateContext(userMessage, "available properties", answer);
                    return {
                        question: "available properties",
                        answer: answer,
                        score: 0.9
                    };
                }
                
                // Check for location questions
                if (normalizedUserMessage.match(/property locations|where are properties|locations available|available locations/i)) {
                    const answer = getLocationResponse();
                    updateContext(userMessage, "property locations", answer);
                    return {
                        question: "property locations",
                        answer: answer,
                        score: 0.9
                    };
                }
                
                // Check for specific listings request
                if (normalizedUserMessage.match(/specific listings|show me listings|show listings|specific properties/i)) {
                    const answer = getSpecificListingsResponse();
                    updateContext(userMessage, "specific listings", answer);
                    return {
                        question: "specific listings",
                        answer: answer,
                        score: 0.9
                    };
                }
                
                // Standard similarity matching with context awareness
                let bestMatchIndex = -1;
                let bestMatchScore = 0;
                let contextAdjustedScore = 0;
                
                // First, check if there's a lastContext and adjust the score
                if (lastContext && typeof lastContext === 'object' && lastContext.question) {
                    const contextSimilarity = calculateSimilarity(normalizedUserMessage, lastContext.question);
                    contextAdjustedScore = contextSimilarity * 0.3; // Increase context weight
                }
                
                // Check each question in the dataset
                for (let i = 0; i < qaData.questions.length; i++) {
                    // Normalize question
                    const normalizedQuestion = qaData.questions[i].toLowerCase().trim();
                    let similarity = calculateSimilarity(normalizedUserMessage, normalizedQuestion);
                    
                    // Boost score based on context relevance
                    if (conversationContext.topic) {
                        if (normalizedQuestion.includes(conversationContext.topic)) {
                            similarity += 0.2;
                        }
                    }
                    
                    // Add context-adjusted score with higher weight for follow-up questions
                    if (lastContext) {
                        similarity += contextAdjustedScore;
                    }
                    
                    if (similarity > bestMatchScore) {
                        bestMatchScore = similarity;
                        bestMatchIndex = i;
                    }
                }
                
                // Check if the match is good enough
                if (bestMatchIndex !== -1 && bestMatchScore > 0.3) {
                    const question = qaData.questions[bestMatchIndex];
                    const answer = qaData.answers[bestMatchIndex];
                    
                    // Update context with this match
                    updateContext(userMessage, question, answer);
                    
                    // Update lastContext for backward compatibility
                    lastContext = {
                        question: question,
                        answer: answer
                    };
                    
                    return {
                        question: question,
                        answer: answer,
                        score: bestMatchScore
                    };
                }
                
                // If no good match, use context to generate a response
                return generateContextBasedResponse(userMessage);
            } catch (error) {
                console.error("Error finding best match:", error);
                return {
                    question: "error",
                    answer: "I'm having trouble processing your question. Could you please try again with a different question?",
                    score: 0
                };
            }
        }

        // Generate response for available properties
        function getAvailablePropertiesResponse() {
            let response = "We have several properties available in our portfolio:";
            
            // If we know the user's budget, filter by that
            if (conversationContext.budget) {
                if (conversationContext.budget <= 5) {
                    response = `For your budget of around ${conversationContext.budget} million KES, we have:`;
                    response += "\n\n1. Studio apartments in South B starting at KES 4.5 million";
                    response += "\n2. Land plots in Kitengela from KES 3.5 million";
                } else if (conversationContext.budget <= 10) {
                    response = `For your budget of around ${conversationContext.budget} million KES, we have:`;
                    response += "\n\n1. 2-bedroom apartments in Westlands at KES 9.5 million";
                    response += "\n2. 2-bedroom apartments in South B at KES 8.5 million";
                    response += "\n3. 1-bedroom apartments in Kilimani at KES 7.5 million";
                } else {
                    response = `For your budget of around ${conversationContext.budget} million KES, we have:`;
                    response += "\n\n1. 3-bedroom houses in Langata at KES 12 million";
                    response += "\n2. 3-bedroom apartments in Kilimani at KES 15 million";
                    response += "\n3. 4-bedroom townhouses in Karen starting at KES 25 million";
                }
            } 
            // If we know property type, filter by that
            else if (conversationContext.propertyType) {
                if (conversationContext.propertyType === 'apartment') {
                    response += "\n\n1. 2-bedroom apartments in Westlands at KES 9.5 million";
                    response += "\n2. 2-bedroom apartments in South B at KES 8.5 million";
                    response += "\n3. 1-bedroom apartments in Kilimani at KES 7.5 million";
                    response += "\n4. 3-bedroom apartments in Kilimani at KES 15 million";
                } else if (conversationContext.propertyType === 'house') {
                    response += "\n\n1. 3-bedroom houses in Langata at KES 12 million";
                    response += "\n2. 4-bedroom townhouses in Karen starting at KES 25 million";
                    response += "\n3. 5-bedroom villas in Runda at KES 45 million";
                } else if (conversationContext.propertyType === 'land') {
                    response += "\n\n1. 1/4 acre plots in Kitengela at KES 3.5 million";
                    response += "\n2. 1/2 acre plots in Syokimau at KES 7 million";
                    response += "\n3. 1 acre plots in Athi River at KES 12 million";
                }
            }
            // If we know location, filter by that
            else if (conversationContext.location) {
                if (conversationContext.location === 'westlands') {
                    response += "\n\n1. 1-bedroom apartments at KES 7 million";
                    response += "\n2. 2-bedroom apartments at KES 9.5 million";
                    response += "\n3. 3-bedroom apartments at KES 14 million";
                } else if (conversationContext.location === 'south b') {
                    response += "\n\n1. Studio apartments at KES 4.5 million";
                    response += "\n2. 2-bedroom apartments at KES 8.5 million";
                } else if (conversationContext.location === 'karen') {
                    response += "\n\n1. 4-bedroom townhouses at KES 25 million";
                    response += "\n2. 5-bedroom villas at KES 45 million";
                }
            }
            // Default response if no context
            else {
                response += "\n\n1. Studio apartments in South B from KES 4.5 million";
                response += "\n2. 2-bedroom apartments in Westlands from KES 9.5 million";
                response += "\n3. 3-bedroom houses in Langata from KES 12 million";
                response += "\n4. 4-bedroom townhouses in Karen from KES 25 million";
                response += "\n5. Land plots in Kitengela from KES 3.5 million";
            }
            
            response += "\n\nWould you like more details about any of these properties?";
            return response;
        }

        // Generate response for location questions
        function getLocationResponse() {
            // If budget is known, provide locations in that range
            if (conversationContext.budget) {
                if (conversationContext.budget <= 5) {
                    return `For your budget of around ${conversationContext.budget} million KES, we have properties in South B (studio apartments) and Kitengela (land plots). These areas offer good value for money and have potential for appreciation.`;
                } else if (conversationContext.budget <= 10) {
                    return `For your budget of around ${conversationContext.budget} million KES, we have properties in Westlands, South B, and Kilimani. These are well-established areas with good amenities and transport links.`;
                } else {
                    return `For your budget of around ${conversationContext.budget} million KES, we have properties in Langata, Kilimani, Karen, and Runda. These premium locations offer excellent amenities, security, and prestige.`;
                }
            }
            // Default response if no budget context
            return "We have properties in various locations including Kilimani, Westlands, Karen, Nairobi CBD, South B, Langata, and Kitengela. Each area has different property types and price ranges. Would you like information about a specific area or properties within a certain budget?";
        }

        // Get specific listings response
        function getSpecificListingsResponse() {
            return "Here are some specific options in our portfolio:\n\n1. Modern 2 Bedroom Apartment - KES 9,500,000\nLocation: Westlands, near Sarit Centre\nFeatures: 85 sq.m, 1 bathroom, modern finishes\n\n2. 2 Bedroom Apartment in South B - KES 8,500,000\nLocation: South B, Nairobi\nFeatures: 80 sq.m, 1 bathroom, family-friendly neighborhood\n\n3. 3 Bedroom House in Langata - KES 12,000,000\nLocation: Langata, near Nairobi National Park\nFeatures: 150 sq.m, 2 bathrooms, small garden\n\nWould you like to schedule a viewing for any of these properties?";
        }

        // Generate response based on current context
        function generateContextBasedResponse(userMessage) {
            // If we're in a viewing context
            if (conversationContext.topic === 'viewing') {
                return {
                    question: "schedule viewing",
                    answer: "I'd be happy to help you schedule a viewing! Please provide your preferred date and time, and our agents will contact you to confirm the appointment. You can also call us directly at +254 700 123 456.",
                    score: 0.7
                };
            }
            
            // If we're in a buying context
            if (conversationContext.topic === 'buying') {
                return {
                    question: "buying process",
                    answer: "The property buying process involves identifying a property, making an offer, securing financing, conducting inspections, and completing legal paperwork. Our agents can assist you at every step. Would you like to know about specific properties available?",
                    score: 0.7
                };
            }
            
            // If we're in a financing context
            if (conversationContext.topic === 'financing') {
                return {
                    question: "financing options",
                    answer: "We offer various financing options including partnerships with major banks for mortgages with rates from 11.5% to 15%, and installment payment plans for select properties. The typical down payment required is 10-20% of the property value. Would you like more specific information about financing?",
                    score: 0.7
                };
            }
            
            // If we're in a location context
            if (conversationContext.topic === 'location') {
                return {
                    question: "property locations",
                    answer: getLocationResponse(),
                    score: 0.7
                };
            }
            
            // If we know the user is interested in a specific property type
            if (conversationContext.propertyType) {
                return {
                    question: `${conversationContext.propertyType} properties`,
                    answer: `We have several ${conversationContext.propertyType} options available. Would you like to know about specific ${conversationContext.propertyType}s in a particular location or price range?`,
                    score: 0.7
                };
            }
            
            // If we have a follow-up to a previous question
            if (lastContext && isFollowUp(userMessage)) {
                return {
                    question: "follow-up",
                    answer: "I'd be happy to provide more information. Could you please specify what aspect you'd like to know more about?",
                    score: 0.6
                };
            }
            
            // Default fallback - ask for clarification
            return askForClarification();
        }

        // Function to ask for clarification when uncertain
        function askForClarification() {
            const clarificationResponses = [
                "I'm not quite sure what you're asking. Could you provide more details about what you'd like to know?",
                "To help you better, could you clarify what specific information you're looking for?",
                "I want to make sure I understand your question correctly. Could you rephrase or provide more context?",
                "I'd like to give you the most accurate information. Could you be more specific about what you're interested in?"
            ];
            
            // Choose a random clarification response
            const randomIndex = Math.floor(Math.random() * clarificationResponses.length);
            
            return {
                question: "clarification",
                answer: clarificationResponses[randomIndex],
                score: 0.3
            };
        }

        // Log conversation for analysis
        function logConversation(userMessage, botResponse, matchScore) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                userMessage: userMessage,
                botResponse: botResponse,
                matchScore: matchScore,
                context: {...conversationContext}
            };
            
            // Store in localStorage for now (in production, you might send to server)
            try {
                let conversationLog = JSON.parse(localStorage.getItem('conversationLog') || '[]');
                conversationLog.push(logEntry);
                localStorage.setItem('conversationLog', JSON.stringify(conversationLog));
                
                // Log to console for debugging
                console.log("Conversation entry logged:", logEntry);
            } catch (error) {
                console.error("Error logging conversation:", error);
            }
        }

        // Function to add a message to the chat box
        function addMessage(message, isUser = false, question = null) {
            if (!message) {
                console.error("Attempted to add empty message to chat");
                message = isUser ? message : "I'm sorry, I couldn't generate a response. Please try asking again.";
                if (!message) return null; // If still empty and it's a user message, just return
            }
            
            try {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
                const messageId = Date.now().toString();
                messageDiv.id = `msg-${messageId}`;

                // Avatar handling with fallback
                let avatarSrc = isUser ? 'images/user.png' : 'images/bot.png';
                let avatarHTML = `<img src="${avatarSrc}" class="avatar" alt="${isUser ? 'User Avatar' : 'Bot Avatar'}" onerror="this.src='https://via.placeholder.com/30x30?text=${isUser ? 'User' : 'Bot'}';this.onerror='';">`;

                // Create message content with proper formatting
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                // Format the message (handle links, line breaks, etc.)
                const formattedMessage = formatMessage(message);
                messageContent.innerHTML = avatarHTML + formattedMessage; // Add avatar here

                messageDiv.appendChild(messageContent);

                // Add feedback buttons for bot messages
                if (!isUser) {
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'feedback-buttons';
                    feedbackDiv.innerHTML = `
                        <button class="feedback-btn helpful" onclick="provideFeedback('${messageId}', true)" title="This was helpful">üëç</button>
                        <button class="feedback-btn not-helpful" onclick="provideFeedback('${messageId}', false)" title="This needs improvement">üëé</button>
                    `;
                    messageDiv.appendChild(feedbackDiv);

                    // Store the context for follow-up questions
                    if (question) {
                        lastContext = {
                            question: question,
                            answer: message
                        };
                    }
                }

                // Add timestamp
                const timestamp = document.createElement('div');
                timestamp.className = 'message-timestamp';
                const time = new Date();
                timestamp.textContent = time.getHours() + ':' +
                    (time.getMinutes() < 10 ? '0' : '') + time.getMinutes();
                messageDiv.appendChild(timestamp);

                chatBox.appendChild(messageDiv);

                // Scroll to the bottom of the chat box with smooth animation
                chatBox.scrollTo({
                    top: chatBox.scrollHeight,
                    behavior: 'smooth'
                });
                
                // Update suggestions based on context if it's a bot message
                if (!isUser && lastContext) {
                    updateSuggestions(lastContext);
                }

                return messageId;
            } catch (error) {
                console.error("Error adding message to chat:", error);
                // Try to add a simple error message if possible
                try {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message bot';
                    errorDiv.textContent = "Sorry, there was an error displaying this message.";
                    chatBox.appendChild(errorDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                } catch (e) {
                    // If even this fails, just log it
                    console.error("Failed to add error message:", e);
                }
                return null;
            }
        }

        // Function to send a message (global for button access)
        window.sendMessage = function(message) {
            // Prevent multiple simultaneous requests
            if (isProcessingResponse) {
                console.log("Already processing a response, please wait...");
                return;
            }
            
            // Add the user's message to the chat
            if (!message) {
                message = userInput.value.trim();
                if (!message) return;
            }
            
            // Store the message and clear input field immediately
            const userMessage = message;
            userInput.value = ''; // Clear the input field right away
            
            // Add user message to chat
            addMessage(userMessage, true);
            
            // Set processing flag
            isProcessingResponse = true;
            
            // Show typing indicator
            const typingIndicator = showTypingIndicator();
            
            // Show loading state
            showLoadingState(true);
            
            // Simulate processing time
            setTimeout(() => {
                try {
                    // Remove typing indicator
                    if (typingIndicator && typingIndicator.parentNode) {
                        typingIndicator.remove();
                    } else {
                        // If the typing indicator can't be found, try to remove it by ID
                        const indicator = document.getElementById('typing-indicator');
                        if (indicator) indicator.remove();
                    }
                    
                    // Process message and get response
                    let response;
                    let matchScore = 0;
                    let questionContext = null;
                    
                    if (isGreeting(userMessage)) {
                        // If it's a greeting, respond with a random greeting
                        const randomIndex = Math.floor(Math.random() * greetingResponses.length);
                        response = greetingResponses[randomIndex];
                        // Don't reset lastContext here to maintain conversation flow
                        matchScore = 1.0;
                        questionContext = "greeting";
                    } else if (isFollowUp(userMessage) && lastContext) {
                        // Handle follow-up questions with improved context awareness
                        if (typeof lastContext === 'string') {
                            // Handle string-based context
                            if (lastContext.toLowerCase().includes('location') || 
                                lastContext.toLowerCase().includes('area')) {
                                response = getLocationResponse();
                                questionContext = "location details";
                                matchScore = 0.8;
                            } else if (lastContext.toLowerCase().includes('property') || 
                                    lastContext.toLowerCase().includes('buy') || 
                                    lastContext.toLowerCase().includes('million')) {
                                
                                // Check if the message is asking about property search
                                if (userMessage.toLowerCase().includes('search') || 
                                    userMessage.toLowerCase().includes('find properties')) {
                                    showPropertyResultsInChat(filterProperties(), "properties matching your criteria");
                                    isProcessingResponse = false;
                                    showLoadingState(false);
                                    return;
                                } else if (userMessage.toLowerCase().includes('location') || 
                                        userMessage.toLowerCase().includes('where') || 
                                        userMessage.toLowerCase().includes('area')) {
                                    response = getLocationResponse();
                                    questionContext = "location inquiry";
                                    matchScore = 0.8;
                                } else {
                                    response = getSpecificListingsResponse();
                                    questionContext = "property options";
                                    matchScore = 0.9;
                                }
                            } else {
                                response = "I'd be happy to provide more information. Could you please specify what aspect you'd like to know more about?";
                                questionContext = lastContext;
                                matchScore = 0.5;
                            }
                        } else if (lastContext && typeof lastContext === 'object' && lastContext.question) {
                            // Handle object-based context
                            const contextQuestion = lastContext.question.toLowerCase();
                            
                            if (contextQuestion.includes('buy') || 
                                contextQuestion.includes('property') || 
                                contextQuestion.includes('house')) {
                                
                                if (userMessage.toLowerCase().includes('location') || 
                                    userMessage.toLowerCase().includes('where') || 
                                    userMessage.toLowerCase().includes('area') ||
                                    userMessage.toLowerCase().includes('available')) {
                                    response = getLocationResponse();
                                    questionContext = "What locations do you have properties in?";
                                    matchScore = 0.9;
                                } else {
                                    response = getSpecificListingsResponse();
                                    questionContext = "property options";
                                    matchScore = 0.9;
                                }
                            } else if (contextQuestion.includes('location') || contextQuestion.includes('area')) {
                                response = "I'd be happy to tell you more about our locations. " + getLocationResponse();
                                questionContext = "Tell me more about locations";
                                matchScore = 0.8;
                            } else {
                                // For other contexts, provide a relevant follow-up
                                const match = findBestMatch(userMessage);
                                response = match.answer;
                                questionContext = match.question;
                                matchScore = match.score;
                            }
                        } else {
                            // Fallback if lastContext is in an unexpected format
                            const match = findBestMatch(userMessage);
                            response = match.answer;
                            questionContext = match.question;
                            matchScore = match.score;
                        }
                    } else if (userMessage.toLowerCase().includes('schedule') && 
                            userMessage.toLowerCase().includes('viewing')) {
                        // Handle scheduling request
                        response = "I'd be happy to help you schedule a viewing! Please provide your preferred date and time, and our agents will contact you to confirm the appointment. You can also call us directly at +254 700 123 456.";
                        questionContext = "schedule viewing";
                        matchScore = 1.0;
                        
                        // Update conversation context
                        conversationContext.topic = 'viewing';
                    } else {
                        // Find the best matching question and answer
                        const match = findBestMatch(userMessage);
                        response = match.answer;
                        questionContext = match.question;
                        matchScore = match.score;
                    }
                    
                    // Ensure we have a response
                    if (!response) {
                        response = "I'm sorry, I couldn't generate a response. Please try asking again.";
                        console.error("Empty response generated for user message:", userMessage);
                        matchScore = 0;
                        questionContext = "error";
                    }
                    
                    // Log the conversation for analysis
                    logConversation(userMessage, response, matchScore);
                    
                    // Add bot response to chat
                    addMessage(response, false, questionContext);
                    
                    // Update lastContext for backward compatibility
                    lastContext = {
                        question: questionContext,
                        answer: response
                    };
                } catch (error) {
                    console.error("Error processing message:", error);
                    addMessage("I'm sorry, I encountered an error while processing your message. Please try again.", false);
                } finally {
                    // Reset processing flag and loading state
                    isProcessingResponse = false;
                    showLoadingState(false);
                }
            }, 1500); // 1.5 seconds delay for typing effect
        };

        // Function to handle feedback (global for button access)
        window.provideFeedback = function(messageId, isPositive) {
            try {
                // Find the message by ID
                const message = document.getElementById(`msg-${messageId}`);
                if (!message) {
                    console.error("Message not found for feedback:", messageId);
                    return;
                }
                
                const feedbackDiv = message.querySelector('.feedback-buttons');
                if (feedbackDiv) {
                    feedbackDiv.innerHTML = isPositive ? 
                        '<span class="feedback-text">Thanks for your feedback! üòä</span>' : 
                        '<span class="feedback-text">Thanks for your feedback. We\'ll improve. üôè</span>';
                    
                    // You could also send this feedback to a server for analysis
                    console.log(`User provided ${isPositive ? 'positive' : 'negative'} feedback for message:`, messageId);
                }
            } catch (error) {
                console.error("Error providing feedback:", error);
            }
        };

        // Update suggestions based on conversation context
        function updateSuggestions(context) {
            try {
                const suggestionsDiv = document.querySelector('.suggestion-buttons');
                if (!suggestionsDiv) {
                    console.warn("Suggestions div not found");
                    return;
                }
                
                let newSuggestions = [];
                
                // Check context and provide relevant suggestions
                if (!context) {
                    // Default suggestions
                    newSuggestions = [
                        'Property viewing process',
                        'Document requirements',
                        'Property prices in Nairobi',
                        'Mortgage options'
                    ];
                } else if (typeof context === 'string') {
                    if (context.toLowerCase().includes('location') || context.toLowerCase().includes('area')) {
                        newSuggestions = [
                            'Properties in Westlands',
                            'Properties in Karen',
                            'Properties in Kilimani',
                            'Upcoming developments'
                        ];
                    } else if (context.toLowerCase().includes('price') || context.toLowerCase().includes('cost') || 
                            context.toLowerCase().includes('million')) {
                        newSuggestions = [
                            'Properties under 5 million',
                            'Properties around 10 million',
                            'Luxury properties',
                            'Payment plans available'
                        ];
                    } else if (context.toLowerCase().includes('buy') || context.toLowerCase().includes('purchase')) {
                        newSuggestions = [
                            'Buying process',
                            'Required documents',
                            'Schedule a viewing',
                            'Financing options'
                        ];
                    } else if (context.toLowerCase().includes('property options')) {
                        newSuggestions = [
                            'Schedule a viewing',
                            'More details on Westlands',
                            'More details on South B',
                            'More details on Langata'
                        ];
                    } else if (context.toLowerCase().includes('schedule')) {
                        newSuggestions = [
                            'View Westlands property',
                            'View South B property',
                            'View Langata property',
                            'Contact an agent'
                        ];
                    }
                } else if (context && typeof context === 'object' && context.question) {
                    // Handle context based on the question property
                    const question = context.question.toLowerCase();
                    
                    if (question.includes('location') || question.includes('area')) {
                        newSuggestions = [
                            'Properties in Westlands',
                            'Properties in Karen',
                            'Properties in Kilimani',
                            'Upcoming developments'
                        ];
                    } else if (question.includes('price') || question.includes('cost') || 
                            question.includes('million')) {
                        newSuggestions = [
                            'Properties under 5 million',
                            'Properties around 10 million',
                            'Luxury properties',
                            'Payment plans available'
                        ];
                    } else if (question.includes('buy') || question.includes('purchase')) {
                        newSuggestions = [
                            'Buying process',
                            'Required documents',
                            'Schedule a viewing',
                            'Financing options'
                        ];
                    } else if (question.includes('mortgage') || question.includes('loan')) {
                        newSuggestions = [
                            'Current interest rates',
                            'Mortgage requirements',
                            'Down payment options',
                            'Loan approval process'
                        ];
                    } else if (question.includes('document') || question.includes('legal')) {
                        newSuggestions = [
                            'Title deed verification',
                            'Sale agreement details',
                            'Required identification',
                            'Legal fees involved'
                        ];
                    }
                }
                
                // Only update if we have new suggestions
                if (newSuggestions.length > 0) {
                    // Update the suggestion buttons
                    suggestionsDiv.innerHTML = '';
                    
                    newSuggestions.forEach((suggestion, index) => {
                        const button = document.createElement('button');
                        button.className = 'suggestion-btn';
                        button.style.setProperty('--btn-index', index);
                        button.textContent = suggestion;
                        button.addEventListener('click', () => {
                            sendMessage(suggestion);
                        });
                        suggestionsDiv.appendChild(button);
                    });
                }
            } catch (error) {
                console.error("Error updating suggestions:", error);
            }
        }


        // Function to filter properties based on search criteria
        function filterProperties() {
            try {
                const location = document.getElementById('location')?.value?.toLowerCase() || '';
                const minPrice = parseInt(document.getElementById('min_price')?.value) || 0;
                const maxPrice = parseInt(document.getElementById('max_price')?.value) || Number.MAX_SAFE_INTEGER;
                const propertyType = document.getElementById('type')?.value?.toLowerCase() || '';
                const bedrooms = parseInt(document.getElementById('bedrooms')?.value) || 0;
                
                return properties.filter(property => {
                    // Check location
                    if (location && !property.location.toLowerCase().includes(location)) {
                        return false;
                    }
                    
                    // Check price range
                    if (property.price < minPrice || property.price > maxPrice) {
                        return false;
                    }
                    
                    // Check property type
                    if (propertyType && property.type.toLowerCase() !== propertyType) {
                        return false;
                    }
                    
                    // Check bedrooms
                    if (bedrooms > 0 && property.bedrooms < bedrooms) {
                        return false;
                    }
                    
                    return true;
                });
            } catch (error) {
                console.error("Error filtering properties:", error);
                return []; // Return empty array on error
            }
        }

        // Function to display property results in search page
        function displayPropertyResults(filteredProperties) {
            try {
                propertyResults.innerHTML = '';
                
                if (!filteredProperties || filteredProperties.length === 0) {
                    propertyResults.innerHTML = '<p>No properties match your search criteria.</p>';
                    return;
                }
                
                filteredProperties.forEach(property => {
                    const propertyCard = document.createElement('div');
                    propertyCard.className = 'property-card';
                    
                    // Add property badge for new or featured properties
                    const badgeHtml = property.id % 2 === 0 ? '<div class="property-badge">New</div>' : 
                                    (property.id % 3 === 0 ? '<div class="property-badge" style="background-color: var(--secondary-color);">Featured</div>' : '');
                    
                    propertyCard.innerHTML = `
                        <div class="property-image" style="background-image: url('${property.image}')">
                            ${badgeHtml}
                        </div>
                        <div class="property-info">
                            <div class="property-title">${property.title}</div>
                            <div class="property-location">${property.location}</div>
                            <div class="property-price">KES ${property.price.toLocaleString()}</div>
                            <div class="property-features">
                                <div class="feature"><i class="fas fa-bed"></i> ${property.bedrooms} Bed${property.bedrooms !== 1 ? 's' : ''}</div>
                                <div class="feature"><i class="fas fa-bath"></i> ${property.bathrooms} Bath${property.bathrooms !== 1 ? 's' : ''}</div>
                                <div class="feature"><i class="fas fa-ruler-combined"></i> ${property.size} m¬≤</div>
                            </div>
                            <button class="view-btn" onclick="viewPropertyDetails(${property.id})">View Details</button>
                        </div>
                    `;
                    
                    propertyResults.appendChild(propertyCard);
                });
            } catch (error) {
                console.error("Error displaying property results:", error);
                propertyResults.innerHTML = '<p>An error occurred while displaying properties. Please try again.</p>';
            }
        }

        // Function to display property results in chat
        function showPropertyResultsInChat(properties, query) {
            try {
                if (!properties || properties.length === 0) {
                    addMessage(`I couldn't find any properties matching "${query}". Would you like to try different search criteria?`);
                    return;
                }
                
                // Add intro message
                addMessage(`I found ${properties.length} properties that match your criteria. Here are some options:`);
                
                // Create a property results container
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'chat-property-results';
                
                // Add up to 3 properties
                const displayProperties = properties.slice(0, 3);
                displayProperties.forEach(property => {
                    const propertyCard = document.createElement('div');
                    propertyCard.className = 'chat-property-card';
                    
                    propertyCard.innerHTML = `
                        <div class="chat-property-image" style="background-image: url('${property.image}')"></div>
                        <div class="chat-property-info">
                            <div class="chat-property-title">${property.title}</div>
                            <div class="chat-property-location">${property.location}</div>
                            <div class="chat-property-price">KES ${property.price.toLocaleString()}</div>
                            <div class="chat-property-specs">${property.bedrooms} Bed ‚Ä¢ ${property.bathrooms} Bath ‚Ä¢ ${property.size} m¬≤</div>
                            <button class="chat-property-link" onclick="viewPropertyDetails(${property.id})">View Details</button>
                        </div>
                    `;
                    
                    resultsContainer.appendChild(propertyCard);
                });
                
                // Add "View All" link if there are more than 3 properties
                if (properties.length > 3) {
                    const viewAllLink = document.createElement('a');
                    viewAllLink.href = "#";
                    viewAllLink.className = 'view-all-link';
                    viewAllLink.textContent = `View all ${properties.length} properties ‚Üí`;
                    viewAllLink.onclick = function(e) {
                        e.preventDefault();
                        chatLink.classList.remove('active');
                        searchLink.classList.add('active');
                        chatView.style.display = 'none';
                        searchView.style.display = 'grid';
                        displayPropertyResults(properties);
                    };
                    resultsContainer.appendChild(viewAllLink);
                }
                
                // Add the container to chat
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                messageDiv.appendChild(resultsContainer);
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                
                // Add a follow-up message
                setTimeout(() => {
                    addMessage("Would you like more information about any of these properties?");
                    lastContext = "property options";
                }, 1000);
            } catch (error) {
                console.error("Error showing property results in chat:", error);
                addMessage("I'm sorry, I encountered an error while displaying properties. Please try again.");
            }
        }

        // Function to view property details (global for button access)
        window.viewPropertyDetails = function(propertyId) {
            try {
                const property = properties.find(p => p.id === propertyId);
                if (!property) {
                    console.error("Property not found:", propertyId);
                    alert("Sorry, property details are not available.");
                    return;
                }
                
                alert(`Property Details: ${property.title}\n\nLocation: ${property.location}\nPrice: KES ${property.price.toLocaleString()}\nBedrooms: ${property.bedrooms}\nBathrooms: ${property.bathrooms}\nSize: ${property.size} m¬≤\n\nDescription: ${property.description}\n\nThis is a demo. In a full application, this would link to a detailed property page.`);
            } catch (error) {
                console.error("Error viewing property details:", error);
                alert("Sorry, there was an error displaying property details.");
            }
        };

        // Welcome tour for first-time visitors
        function showWelcomeTour() {
            try {
                setTimeout(() => {
                    addMessage("üëã Welcome to Kwetu Homes AI Assistant! I'm here to help you with all your real estate needs.");
                }, 1000);
                
                setTimeout(() => {
                    addMessage("You can ask me about property locations, prices, the buying process, and more. I'll do my best to provide helpful information.");
                }, 4000);
                
                setTimeout(() => {
                    addMessage("Try the suggestion chips for common questions, or just type your query. Ready to find your dream home?");
                }, 7000);
            } catch (error) {
                console.error("Error showing welcome tour:", error);
                // Try to add a simple welcome message if the tour fails
                addMessage("üëã Welcome to Kwetu Homes AI Assistant! How can I help you today?");
            }
        }

        // Check if user is a first-time visitor
        function checkFirstTimeVisitor() {
            try {
                if (!localStorage.getItem('hasVisitedBefore')) {
                    // Show welcome tour
                    showWelcomeTour();
                    
                    // Set flag in localStorage
                    localStorage.setItem('hasVisitedBefore', 'true');
                }
            } catch (error) {
                console.error("Error checking first-time visitor:", error);
                // If localStorage fails, just show the welcome tour anyway
                showWelcomeTour();
            }
        }

        // Reset chat function
        function resetChat() {
            try {
                // Remove all messages except the welcome message
                const messages = document.querySelectorAll('.message:not(#msg-welcome)');
                messages.forEach(message => {
                    // Add fade-out animation
                    message.classList.add('fade-out');
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.remove();
                        }
                    }, 300);
                });
                
                // Reset context
                lastContext = null;
                
                // Reset suggestions
                updateSuggestions(null);
                
                // Add a system message
                setTimeout(() => {
                    addMessage("Conversation has been reset. How can I help you today?");
                }, 350);
            } catch (error) {
                console.error("Error resetting chat:", error);
                alert("There was an error resetting the chat. Please refresh the page.");
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', function() {
            sendMessage(userInput.value.trim());
        });
        
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage(userInput.value.trim());
            }
        });
        
        suggestionBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                sendMessage(this.textContent);
            });
        });
        
        chatLink.addEventListener('click', function(e) {
            e.preventDefault();
            chatView.style.display = 'grid';
            searchView.style.display = 'none';
            chatLink.classList.add('active');
            searchLink.classList.remove('active');
        });
        
        searchLink.addEventListener('click', function(e) {
            e.preventDefault();
            chatView.style.display = 'none';
            searchView.style.display = 'grid';
            chatLink.classList.remove('active');
            searchLink.classList.add('active');
            
            // Load all properties
            displayPropertyResults(properties);
        });
        
        searchBtn.addEventListener('click', function() {
            const filteredProperties = filterProperties();
            displayPropertyResults(filteredProperties);
        });
        
        resetChatBtn.addEventListener('click', resetChat);
        
        toggleSuggestionsBtn.addEventListener('click', function() {
            const suggestions = document.querySelector('.suggestions');
            if (suggestions) {
                suggestions.classList.toggle('show-suggestions');
            }
        });
        
        // Make sure these elements exist before adding event listeners
        if (searchPropertiesBtn) {
            searchPropertiesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                chatLink.classList.remove('active');
                searchLink.classList.add('active');
                chatView.style.display = 'none';
                searchView.style.display = 'grid';
                
                // Load all properties
                displayPropertyResults(properties);
            });
        }
        
        if (scheduleViewingBtn) {
            scheduleViewingBtn.addEventListener('click', function(e) {
                e.preventDefault();
                sendMessage('I would like to schedule a property viewing');
            });
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Alt+R to reset chat
            if (e.altKey && e.key === 'r') {
                e.preventDefault();
                resetChat();
            }
            
            // Alt+S to focus search input
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                userInput.focus();
            }
        });
        
        // Initialize with all properties
        displayPropertyResults(properties);
        
        // Focus on input field
        setTimeout(() => {
            userInput.focus();
        }, 1000);
    });
</script>